#!/bin/bash
# hypr-devns-exec â€” namespace-aware app launcher
# Wraps any command to run inside the active workspace's network namespace.
# Creates the namespace on-demand if the daemon hasn't set it up yet.
# Falls through to direct exec if workspace ID is invalid.

. /usr/share/hypr-workflow/lib/devns-common.sh

if [ $# -eq 0 ]; then
    echo "usage: hypr-devns-exec <command...>" >&2
    exit 1
fi

# Apps listed in DEVNS_HOST_APPS run on the host (e.g. browsers that use
# the devns extension+proxy for per-tab namespace routing).
for _arg in "$@"; do
    for _app in $DEVNS_HOST_APPS; do
        [ "$_app" = "$_arg" ] && exec "$@"
    done
done

ws_id="$(hyprctl activeworkspace -j | jq -r '.id')"

if [ "$ws_id" -gt 0 ] 2>/dev/null; then
    ns="$(devns_ns_name "$ws_id")"
    if [ ! -e "/run/netns/${ns}" ]; then
        sudo /usr/bin/hypr-devns-helper create "$(devns_ns_id "$ws_id")" 2>/dev/null
    fi
    if [ -e "/run/netns/${ns}" ]; then
        export DEVNS_WS="$ws_id"
        exec sudo -E /usr/bin/hypr-devns-nsexec "$ns" "$(id -u)" "$(id -g)" "$@"
    fi
fi

exec "$@"
