#!/bin/bash
# hypr-devns-exec â€” namespace-aware app launcher
# Wraps any command to run inside the active workspace's network namespace.
# Creates the namespace on-demand if the daemon hasn't set it up yet.
# Falls through to direct exec if workspace ID is invalid.

. /usr/share/hyprflow/lib/devns-common.sh

if [ $# -eq 0 ]; then
    echo "usage: hypr-devns-exec <command...>" >&2
    exit 1
fi

# Browsers are launched via firejail with isolated profiles.
# The browser command may be wrapped (e.g. "uwsm-app -- helium-browser"),
# so find the browser arg and pass it (plus any trailing args) to the launcher.
_args=("$@")
for _i in "${!_args[@]}"; do
    for _browser in $DEVNS_BROWSERS; do
        [ "$_browser" = "${_args[$_i]}" ] && exec hypr-devns-browser "${_args[@]:$_i}"
    done
done

ws_id="$(hyprctl activeworkspace -j | jq -r '.id')"

if [ "$ws_id" -gt 0 ] 2>/dev/null; then
    ns="$(devns_ns_name "$ws_id")"
    if [ ! -e "/run/netns/${ns}" ]; then
        sudo /usr/bin/hypr-devns-helper create "$(devns_ns_id "$ws_id")" 2>/dev/null
    fi
    if [ -e "/run/netns/${ns}" ]; then
        export DEVNS_WS="$ws_id"
        exec sudo -E /usr/bin/hypr-devns-nsexec "$ns" "$(id -u)" "$(id -g)" "$@"
    fi
fi

exec "$@"
