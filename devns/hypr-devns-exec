#!/bin/bash
# hypr-devns-exec — namespace-aware app launcher
# Wraps any command to run inside the active workspace's network namespace.
# Creates the namespace on-demand if the daemon hasn't set it up yet.
# Falls through to direct exec if workspace ID is invalid.

. /usr/share/hyprflow/lib/devns-common.sh

if [ $# -eq 0 ]; then
    echo "usage: hypr-devns-exec <command...>" >&2
    exit 1
fi

# Browsers are launched via firejail with isolated profiles.
# The browser command may be wrapped (e.g. "uwsm-app -- helium-browser"),
# so find the browser arg and pass it (plus any trailing args) to the launcher.
_args=("$@")
for _i in "${!_args[@]}"; do
    for _browser in $DEVNS_BROWSERS; do
        [ "$_browser" = "${_args[$_i]}" ] && exec hypr-devns-browser "${_args[@]:$_i}"
    done
done

ws_id="$(hyprctl activeworkspace -j | jq -r '.id')"

# Workspace excluded from namespace isolation — run directly on host
if ! devns_ws_enabled "$ws_id"; then
    exec "$@"
fi

ns="$(devns_ns_name "$ws_id")"
if [ ! -e "${DEVNS_NETNS_DIR}/${ns}" ]; then
    if ! sudo /usr/bin/hypr-devns-helper create "$(devns_ns_id "$ws_id")" 2>&1; then
        devns_warn "namespace creation failed for ws $ws_id, running on host"
    fi
fi
if [ -e "${DEVNS_NETNS_DIR}/${ns}" ]; then
    export DEVNS_WS="$ws_id"
    exec sudo -E /usr/bin/hypr-devns-nsexec "$ns" "$(id -u)" "$(id -g)" "$@"
fi

exec "$@"
