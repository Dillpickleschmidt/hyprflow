#!/bin/bash
# hypr-devns-helper â€” privileged namespace lifecycle management
# Runs as root via sudo. Subcommands: create <id>, destroy <id>, destroy-all

set -euo pipefail

. /usr/share/hypr-workflow/lib/devns-common.sh

ns_create() {
    local id="$1"
    devns_validate_id "$id" || exit 1

    local ns="$(devns_ns_name "$id")"
    local veth_h="veth_h${id}"
    local veth_n="veth_n${id}"
    local subnet="$(devns_subnet "$id")"
    local wan
    wan="$(devns_get_wan_iface)"

    if [ -z "$wan" ]; then
        echo "error: could not detect WAN interface" >&2
        exit 1
    fi

    # Create namespace if it doesn't exist
    if ! ip netns list | grep -qw "$ns"; then
        ip netns add "$ns"
    fi

    # Skip networking setup if veth already exists inside the namespace
    if ip netns exec "$ns" ip link show "$veth_n" &>/dev/null; then
        return 0
    fi

    # Clean up stale host-side veth if it exists without its peer
    ip link delete "$veth_h" 2>/dev/null || true

    ip link add "$veth_h" type veth peer name "$veth_n"
    ip link set "$veth_n" netns "$ns"

    ip addr add "${subnet}.1/24" dev "$veth_h"
    ip link set "$veth_h" up

    ip netns exec "$ns" ip addr add "${subnet}.2/24" dev "$veth_n"
    ip netns exec "$ns" ip link set "$veth_n" up
    ip netns exec "$ns" ip link set lo up
    ip netns exec "$ns" ip route add default via "${subnet}.1" table 100
    ip netns exec "$ns" ip rule add from all lookup main suppress_prefixlength 0 prio 32500
    ip netns exec "$ns" ip rule add from all lookup 200 prio 32550
    ip netns exec "$ns" ip rule add from all lookup 100 prio 32600

    # Redirect traffic arriving on the veth IP to loopback so dev servers
    # binding to 127.0.0.1 are reachable from the proxy
    ip netns exec "$ns" sysctl -q net.ipv4.conf.all.route_localnet=1
    ip netns exec "$ns" iptables -t nat -A PREROUTING -d "${subnet}.2" -j DNAT --to-destination 127.0.0.1

    sysctl -q net.ipv4.ip_forward=1

    iptables -t nat -A POSTROUTING -s "${subnet}.0/24" -o "$wan" -j MASQUERADE
    iptables -A FORWARD -i "$veth_h" -o "$wan" -j ACCEPT
    iptables -A FORWARD -i "$wan" -o "$veth_h" -m state --state RELATED,ESTABLISHED -j ACCEPT

    mkdir -p "/etc/netns/${ns}"
    echo "$wan" > "/etc/netns/${ns}/wan_iface"
    : > "/etc/netns/${ns}/resolv.conf"
    for dns in $DEVNS_DNS; do
        echo "nameserver $dns" >> "/etc/netns/${ns}/resolv.conf"
    done

    # Force "localhost" to resolve to IPv4 so dev servers bind to 127.0.0.1
    # (reachable via the DNAT rule above). Two overrides needed:
    # 1. nsswitch: put "files" first so /etc/hosts is checked before
    #    systemd-resolved (which hardcodes ::1 for localhost)
    # 2. hosts: remove localhost from the ::1 line
    sed '/^hosts:/{s/ files//; s/^hosts:/hosts: files/}' \
        /etc/nsswitch.conf > "/etc/netns/${ns}/nsswitch.conf"
    cp /etc/hosts "/etc/netns/${ns}/hosts"
    sed -i '/^::1/{s/$/ /; s/[[:space:]]/ /g; s/ localhost\.localdomain / /g; s/ localhost / /g; s/  */ /g; s/ $//}' "/etc/netns/${ns}/hosts"
}

ns_destroy() {
    local id="$1"
    devns_validate_id "$id" || exit 1

    local ns="$(devns_ns_name "$id")"
    local veth_h="veth_h${id}"
    local subnet="$(devns_subnet "$id")"
    local wan
    if [ -f "/etc/netns/${ns}/wan_iface" ]; then
        wan="$(cat "/etc/netns/${ns}/wan_iface")"
    else
        wan="$(devns_get_wan_iface)"
    fi

    if ! ip netns list | grep -qw "$ns"; then
        return 0
    fi

    # Remove iptables rules (ignore errors if rules don't exist)
    if [ -n "$wan" ]; then
        iptables -t nat -D POSTROUTING -s "${subnet}.0/24" -o "$wan" -j MASQUERADE 2>/dev/null || true
        iptables -D FORWARD -i "$veth_h" -o "$wan" -j ACCEPT 2>/dev/null || true
        iptables -D FORWARD -i "$wan" -o "$veth_h" -m state --state RELATED,ESTABLISHED -j ACCEPT 2>/dev/null || true
    fi

    ip netns delete "$ns"
    # veth pair is auto-removed when namespace is deleted

    rm -rf "/etc/netns/${ns}"
}

ns_destroy_all() {
    for ns in $(ip netns list | awk '/^hyprns_/{print $1}'); do
        local id="${ns#hyprns_}"
        ns_destroy "$id" || true
    done
}

case "${1:-}" in
    create)
        [ -z "${2:-}" ] && { echo "usage: hypr-devns-helper create <id>" >&2; exit 1; }
        ns_create "$2"
        ;;
    destroy)
        [ -z "${2:-}" ] && { echo "usage: hypr-devns-helper destroy <id>" >&2; exit 1; }
        ns_destroy "$2"
        ;;
    destroy-all)
        ns_destroy_all
        ;;
    *)
        echo "usage: hypr-devns-helper {create|destroy|destroy-all} [id]" >&2
        exit 1
        ;;
esac
