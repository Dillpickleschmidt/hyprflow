#!/bin/bash
# hypr-devns-browser — launch browser in workspace namespace with isolated profile

. /usr/share/hyprflow/lib/devns-common.sh

browser_cmd="$1"
shift

ws_id="$(hyprctl activeworkspace -j | jq -r '.id')"
group_id=$(( (ws_id - 1) / 10 + 1 ))
ns="hyprns_${group_id}"

# Ensure namespace exists
if [ ! -e "/var/run/netns/${ns}" ]; then
    sudo /usr/bin/hypr-devns-helper create "$group_id" 2>/dev/null
fi

profile_dir="$HOME/.config/hyprflow/browsers/${browser_cmd}-wg${group_id}"

# Determine browser type, source profile, and profile flag
case "$browser_cmd" in
    firefox)
        browser_type="firefox"
        source_profile="$HOME/.mozilla/firefox"
        ;;
    librewolf)
        browser_type="firefox"
        source_profile="$HOME/.librewolf"
        ;;
    floorp)
        browser_type="firefox"
        source_profile="$HOME/.floorp"
        ;;
    zen-browser)
        browser_type="firefox"
        source_profile="$HOME/.zen"
        ;;
    helium-browser)
        browser_type="chromium"
        source_profile="$HOME/.config/net.imput.helium"
        ;;
    brave)
        browser_type="chromium"
        source_profile="$HOME/.config/BraveSoftware/Brave-Browser"
        ;;
    google-chrome-stable)
        browser_type="chromium"
        source_profile="$HOME/.config/google-chrome"
        ;;
    microsoft-edge-stable)
        browser_type="chromium"
        source_profile="$HOME/.config/microsoft-edge"
        ;;
    *)
        # chromium, vivaldi-stable, etc. — typically ~/.config/<cmd>
        browser_type="chromium"
        source_profile="$HOME/.config/${browser_cmd}"
        ;;
esac

# Clone base profile on first launch for this workspace group
if [ ! -d "$profile_dir" ]; then
    if [ "$browser_type" = "firefox" ]; then
        # Find the default profile directory from profiles.ini
        profiles_ini="${source_profile}/profiles.ini"
        if [ -f "$profiles_ini" ]; then
            default_rel=$(awk -F= '/^\[Install/{found=1} found && /^Default=/{print $2; exit}' "$profiles_ini")
            if [ -n "$default_rel" ]; then
                source_dir="${source_profile}/${default_rel}"
            fi
        fi
        if [ -z "$source_dir" ] || [ ! -d "$source_dir" ]; then
            # Fallback: find the *.default-release profile
            source_dir=$(find "$source_profile" -maxdepth 1 -name '*.default-release' -type d | head -1)
        fi
        if [ -d "$source_dir" ]; then
            rsync -a \
                --exclude='lock' \
                --exclude='.parentlock' \
                --exclude='cache2/' \
                --exclude='OfflineCache/' \
                --exclude='startupCache/' \
                --exclude='thumbnails/' \
                --exclude='safebrowsing/' \
                --exclude='storage/temporary/' \
                --exclude='minidumps/' \
                --exclude='compatibility.ini' \
                --exclude='extensions.json' \
                --exclude='addonStartup.json.lz4' \
                --exclude='storage/default/http+++localhost*' \
                --exclude='serviceworker*' \
                "$source_dir/" "$profile_dir/"
        else
            mkdir -p "$profile_dir"
        fi
    else
        # Chromium-based
        if [ -d "$source_profile" ]; then
            rsync -a \
                --exclude='SingletonLock' \
                --exclude='SingletonCookie' \
                --exclude='SingletonSocket' \
                --exclude='Cache/' \
                --exclude='Code Cache/' \
                --exclude='GPUCache/' \
                --exclude='ShaderCache/' \
                --exclude='GrShaderCache/' \
                --exclude='Service Worker/' \
                --exclude='CrashpadMetrics-active.pma' \
                --exclude='Crashpad/' \
                --exclude='BrowserMetrics/' \
                --exclude='crash_count' \
                --exclude='*/Service Worker/' \
                --exclude='*/Cache/' \
                --exclude='*/Code Cache/' \
                --exclude='*/GPUCache/' \
                --exclude='*/IndexedDB/*http_localhost*' \
                --exclude='*/Local Storage/leveldb/*http_localhost*' \
                "$source_profile/" "$profile_dir/"
        else
            mkdir -p "$profile_dir"
        fi
    fi
fi

# Launch with firejail
if [ "$browser_type" = "firefox" ]; then
    exec firejail --noprofile --netns="$ns" \
        "$browser_cmd" --no-remote --profile "$profile_dir" "$@"
else
    exec firejail --noprofile --netns="$ns" \
        "$browser_cmd" --user-data-dir="$profile_dir" "$@"
fi
