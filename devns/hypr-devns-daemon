#!/bin/bash
# hypr-devns-daemon — user-level namespace lifecycle manager
# Listens to Hyprland IPC for workspace events, lazily creates namespaces.

# No -e: the socat reconnect loop uses non-fatal exits to detect socket loss
set -uo pipefail

. /usr/share/hypr-workflow/lib/devns-common.sh

STATE_DIR="${XDG_RUNTIME_DIR}/hypr-devns"
mkdir -p "$STATE_DIR"

# Set persistent workspace rules for the active group so waybar shows the right workspaces
hypr-workspace-group init

should_namespace() {
    local id="$1"
    # Skip special workspaces (negative IDs)
    if [ "$id" -le 0 ] 2>/dev/null; then
        return 1
    fi
    if [ "$DEVNS_WORKSPACES" = "all" ]; then
        return 0
    fi
    echo ",$DEVNS_WORKSPACES," | grep -q ",${id},"
}

ensure_namespace() {
    local id="$1"
    if ! should_namespace "$id"; then
        return 0
    fi
    local ns_id
    ns_id="$(devns_ns_id "$id")"
    if [ -f "${STATE_DIR}/ns_${ns_id}" ]; then
        return 0
    fi
    if sudo /usr/bin/hypr-devns-helper create "$ns_id"; then
        touch "${STATE_DIR}/ns_${ns_id}"
    else
        echo "warning: failed to create namespace for workspace $id (ns $ns_id)" >&2
    fi
}

PROXY_PID=""

start_proxy() {
    python3 /usr/share/hypr-workflow/hypr-devns-proxy &
    PROXY_PID=$!
}

update_active_ws() {
    echo "$1" > "${STATE_DIR}/active-ws"
}

cleanup() {
    if [ -n "$PROXY_PID" ]; then
        kill "$PROXY_PID" 2>/dev/null || true
        wait "$PROXY_PID" 2>/dev/null || true
    fi
    sudo /usr/bin/hypr-devns-helper destroy-all 2>/dev/null || true
    rm -rf "$STATE_DIR"
}

trap cleanup EXIT TERM INT

# Create namespace for current workspace on startup
current_ws="$(hyprctl activeworkspace -j | jq -r '.id')" || true
if [ -n "$current_ws" ]; then
    update_active_ws "$current_ws"
    ensure_namespace "$current_ws"
fi

start_proxy

# Determine Hyprland IPC socket path
his="$HYPRLAND_INSTANCE_SIGNATURE"
socket2="${XDG_RUNTIME_DIR}/hypr/${his}/.socket2.sock"

if [ ! -S "$socket2" ]; then
    echo "error: hyprland socket2 not found at $socket2" >&2
    exit 1
fi

# Listen for workspace events (reconnect if socat drops)
while true; do
    socat -u "UNIX-CONNECT:${socket2}" STDOUT 2>/dev/null | while IFS= read -r line; do
        case "$line" in
            workspace\>\>*)
                ws_id="${line#*>>}"
                if [[ "$ws_id" =~ ^[0-9]+$ ]]; then
                    update_active_ws "$ws_id"
                    ensure_namespace "$ws_id"
                fi
                ;;
            createworkspace\>\>*)
                ws_id="${line#*>>}"
                if [[ "$ws_id" =~ ^[0-9]+$ ]]; then
                    ensure_namespace "$ws_id"
                fi
                ;;
            openwindow\>\>*)
                # openwindow can only add a group — skip if group already shown
                ws_id=$(echo "${line#*>>}" | cut -d',' -f2)
                if [[ "$ws_id" =~ ^[0-9]+$ ]] && [ "$ws_id" -gt 0 ]; then
                    grp_base=$(( ((ws_id - 1) / 10) * 10 + 1 ))
                    if ! grep -q "\"${grp_base}\"" "${STATE_DIR}/waybar-pw" 2>/dev/null; then
                        hypr-workspace-group init &
                    fi
                fi
                ;;
            closewindow\>\>*|movewindow\>\>*)
                hypr-workspace-group init &
                ;;
        esac
    done
    # Socket gone means Hyprland exited — stop the daemon
    [ -S "$socket2" ] || break
    sleep 1
done
