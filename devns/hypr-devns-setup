#!/bin/bash
# hypr-devns-setup — configure Omarchy/Hyprland for per-workspace network namespaces
# Run after installing the hypr-workflow package. Idempotent.

set -euo pipefail

. /usr/share/hypr-workflow/lib/devns-common.sh

info() { echo "  $1"; }

echo "hypr-devns: configuring per-workspace network namespaces"
echo

# 0. User config
if [ ! -f "$HOME/.config/hypr-devns.conf" ]; then
    cp /etc/hypr-devns.conf "$HOME/.config/hypr-devns.conf"
    info "config: created ~/.config/hypr-devns.conf"
else
    info "config: ~/.config/hypr-devns.conf already exists"
fi

# 1. Autostart
if grep -q 'hypr-devns-daemon' "$DEVNS_AUTOSTART" 2>/dev/null; then
    info "autostart: already configured"
else
    echo 'exec-once = hypr-devns-daemon' >> "$DEVNS_AUTOSTART"
    info "autostart: added hypr-devns-daemon"
fi

# 2. Bindings — wrap $terminal with hypr-devns-exec
if grep -q 'hypr-devns-exec' "$DEVNS_BINDINGS" 2>/dev/null; then
    info "bindings: already configured"
else
    if grep -q '^\$terminal = ' "$DEVNS_BINDINGS"; then
        sed -i 's/^\$terminal = /\$terminal = hypr-devns-exec /' "$DEVNS_BINDINGS"
        info "bindings: wrapped \$terminal with hypr-devns-exec"
    else
        info "bindings: \$terminal binding not found, skipping"
    fi
fi

# 3. Elephant (Walker app launcher)
if [ -f "$DEVNS_ELEPHANT" ]; then
    if grep -q 'hypr-devns-exec' "$DEVNS_ELEPHANT" 2>/dev/null; then
        info "elephant: already configured"
    elif grep -q '^launch_prefix' "$DEVNS_ELEPHANT" 2>/dev/null; then
        sed -i 's|^launch_prefix.*|launch_prefix = "hypr-devns-exec uwsm-app --"|' "$DEVNS_ELEPHANT"
        info "elephant: replaced existing launch_prefix"
    else
        echo 'launch_prefix = "hypr-devns-exec uwsm-app --"' >> "$DEVNS_ELEPHANT"
        info "elephant: added launch_prefix"
    fi
else
    mkdir -p "$(dirname "$DEVNS_ELEPHANT")"
    echo 'launch_prefix = "hypr-devns-exec uwsm-app --"' > "$DEVNS_ELEPHANT"
    info "elephant: created with launch_prefix"
fi

# 4. Ghostty — override desktop file to disable single-instance
if [ -f "$DEVNS_GHOSTTY_SYSTEM" ]; then
    if [ -f "$DEVNS_GHOSTTY_USER" ] && grep -q 'gtk-single-instance=false' "$DEVNS_GHOSTTY_USER"; then
        info "ghostty: already configured"
    else
        mkdir -p "$(dirname "$DEVNS_GHOSTTY_USER")"
        sed 's/--gtk-single-instance=true/--gtk-single-instance=false/g' \
            "$DEVNS_GHOSTTY_SYSTEM" > "$DEVNS_GHOSTTY_USER"
        info "ghostty: created desktop override (single-instance disabled)"
    fi
else
    info "ghostty: not installed, skipping"
fi

# 5. Browser extensions — Chromium/Helium
add_load_extension() {
    local flags_file="$1"
    local label="$2"
    if [ ! -f "$flags_file" ]; then
        echo "--load-extension=${DEVNS_CHROMIUM_EXTENSION_DIR}" > "$flags_file"
        info "${label}: created with --load-extension"
        return
    fi
    if grep -q "${DEVNS_CHROMIUM_EXTENSION_DIR}" "$flags_file" 2>/dev/null; then
        info "${label}: extension already configured"
        return
    fi
    if grep -q '\-\-load-extension=' "$flags_file"; then
        sed -i "s|--load-extension=\([^ ]*\)|--load-extension=\1,${DEVNS_CHROMIUM_EXTENSION_DIR}|" "$flags_file"
        info "${label}: appended to existing --load-extension"
    else
        echo "--load-extension=${DEVNS_CHROMIUM_EXTENSION_DIR}" >> "$flags_file"
        info "${label}: added --load-extension"
    fi
}

add_load_extension "$DEVNS_CHROMIUM_FLAGS" "chromium"
if command -v helium-browser &>/dev/null; then
    add_load_extension "$DEVNS_HELIUM_FLAGS" "helium"
else
    info "helium: not installed, skipping"
fi

# 6. Browser extensions — Zen (Firefox)
if [ -d "$(dirname "$DEVNS_ZEN_POLICIES")" ]; then
    if [ -f "$DEVNS_ZEN_POLICIES" ] && grep -q 'hypr-devns@localhost' "$DEVNS_ZEN_POLICIES" 2>/dev/null; then
        info "zen: extension already configured"
    else
        # Merge ExtensionSettings into existing policies.json
        ext_policy='{"ExtensionSettings":{"hypr-devns@localhost":{"installation_mode":"normal_installed","install_url":"file:///usr/share/hypr-workflow/extension/firefox/"}}}'
        if [ -f "$DEVNS_ZEN_POLICIES" ]; then
            # Merge with existing using jq
            merged=$(jq --argjson ext "$ext_policy" '.policies = (.policies // {}) * $ext' "$DEVNS_ZEN_POLICIES")
            echo "$merged" | sudo tee "$DEVNS_ZEN_POLICIES" > /dev/null
        else
            echo "{\"policies\": ${ext_policy}}" | sudo tee "$DEVNS_ZEN_POLICIES" > /dev/null
        fi
        info "zen: added extension policy"
    fi
else
    info "zen: not installed, skipping"
fi

# 7. Docker runtime — register hypr-devns-runc as default runtime
if [ -f "$DEVNS_DOCKER_DAEMON_JSON" ] && grep -q 'hypr-devns-runc' "$DEVNS_DOCKER_DAEMON_JSON" 2>/dev/null; then
    info "docker: runtime already configured"
else
    dns_json=$(echo "$DEVNS_DNS" | jq -R '[split(" ") | .[] | select(. != "")]')
    devns_runtime=$(jq -n --argjson dns "$dns_json" '{"default-runtime":"devns","runtimes":{"devns":{"path":"/usr/bin/hypr-devns-runc"}},"dns":$dns}')
    if [ -f "$DEVNS_DOCKER_DAEMON_JSON" ]; then
        merged=$(jq --argjson rt "$devns_runtime" '. * $rt' "$DEVNS_DOCKER_DAEMON_JSON")
        echo "$merged" | sudo tee "$DEVNS_DOCKER_DAEMON_JSON" > /dev/null
    else
        sudo mkdir -p "$(dirname "$DEVNS_DOCKER_DAEMON_JSON")"
        echo "$devns_runtime" | jq . | sudo tee "$DEVNS_DOCKER_DAEMON_JSON" > /dev/null
    fi
    sudo systemctl reload docker 2>/dev/null || true
    info "docker: registered devns runtime"
fi

# 8. Workspace groups — keybindings for grouped workspace navigation
if grep -q 'hypr-workspace-group' "$DEVNS_BINDINGS" 2>/dev/null; then
    info "workspace-groups: bindings already configured"
else
    cat >> "$DEVNS_BINDINGS" << 'WSGROUPS'

# Workspace groups — groups of 10 workspaces share a network namespace
# SUPER+N switches within current group, SUPER+ALT+N switches group

# Unbind default workspace switching
unbind = SUPER, code:10
unbind = SUPER, code:11
unbind = SUPER, code:12
unbind = SUPER, code:13
unbind = SUPER, code:14
unbind = SUPER, code:15
unbind = SUPER, code:16
unbind = SUPER, code:17
unbind = SUPER, code:18
unbind = SUPER, code:19

# Unbind default move-to-workspace
unbind = SUPER SHIFT, code:10
unbind = SUPER SHIFT, code:11
unbind = SUPER SHIFT, code:12
unbind = SUPER SHIFT, code:13
unbind = SUPER SHIFT, code:14
unbind = SUPER SHIFT, code:15
unbind = SUPER SHIFT, code:16
unbind = SUPER SHIFT, code:17
unbind = SUPER SHIFT, code:18
unbind = SUPER SHIFT, code:19

# Unbind default move-to-workspace-silent
unbind = SUPER SHIFT ALT, code:10
unbind = SUPER SHIFT ALT, code:11
unbind = SUPER SHIFT ALT, code:12
unbind = SUPER SHIFT ALT, code:13
unbind = SUPER SHIFT ALT, code:14
unbind = SUPER SHIFT ALT, code:15
unbind = SUPER SHIFT ALT, code:16
unbind = SUPER SHIFT ALT, code:17
unbind = SUPER SHIFT ALT, code:18
unbind = SUPER SHIFT ALT, code:19

# Unbind ALT group tab bindings (freeing ALT for workspace groups)
unbind = SUPER ALT, code:10
unbind = SUPER ALT, code:11
unbind = SUPER ALT, code:12
unbind = SUPER ALT, code:13
unbind = SUPER ALT, code:14
unbind = SUPER ALT, TAB
unbind = SUPER ALT SHIFT, TAB
unbind = SUPER ALT, mouse_down
unbind = SUPER ALT, mouse_up

# Unbind CTRL+TAB (former workspace, replaced by group tab cycling)
unbind = SUPER CTRL, TAB

# Switch within current workspace group
bindd = SUPER, code:10, Switch to sub-workspace 1, exec, hypr-workspace-group ws 1
bindd = SUPER, code:11, Switch to sub-workspace 2, exec, hypr-workspace-group ws 2
bindd = SUPER, code:12, Switch to sub-workspace 3, exec, hypr-workspace-group ws 3
bindd = SUPER, code:13, Switch to sub-workspace 4, exec, hypr-workspace-group ws 4
bindd = SUPER, code:14, Switch to sub-workspace 5, exec, hypr-workspace-group ws 5
bindd = SUPER, code:15, Switch to sub-workspace 6, exec, hypr-workspace-group ws 6
bindd = SUPER, code:16, Switch to sub-workspace 7, exec, hypr-workspace-group ws 7
bindd = SUPER, code:17, Switch to sub-workspace 8, exec, hypr-workspace-group ws 8
bindd = SUPER, code:18, Switch to sub-workspace 9, exec, hypr-workspace-group ws 9
bindd = SUPER, code:19, Switch to sub-workspace 10, exec, hypr-workspace-group ws 10

# Switch workspace group (network namespace)
bindd = SUPER ALT, code:10, Switch to network group 1, exec, hypr-workspace-group switch 1
bindd = SUPER ALT, code:11, Switch to network group 2, exec, hypr-workspace-group switch 2
bindd = SUPER ALT, code:12, Switch to network group 3, exec, hypr-workspace-group switch 3
bindd = SUPER ALT, code:13, Switch to network group 4, exec, hypr-workspace-group switch 4
bindd = SUPER ALT, code:14, Switch to network group 5, exec, hypr-workspace-group switch 5
bindd = SUPER ALT, code:15, Switch to network group 6, exec, hypr-workspace-group switch 6
bindd = SUPER ALT, code:16, Switch to network group 7, exec, hypr-workspace-group switch 7
bindd = SUPER ALT, code:17, Switch to network group 8, exec, hypr-workspace-group switch 8
bindd = SUPER ALT, code:18, Switch to network group 9, exec, hypr-workspace-group switch 9
bindd = SUPER ALT, code:19, Switch to network group 10, exec, hypr-workspace-group switch 10

# Cycle workspace groups (preserving slot position)
bindd = SUPER ALT, TAB, Next network group, exec, hypr-workspace-group next
bindd = SUPER ALT SHIFT, TAB, Previous network group, exec, hypr-workspace-group prev

# Move window within current group
bindd = SUPER SHIFT, code:10, Move window to sub-workspace 1, exec, hypr-workspace-group move 1
bindd = SUPER SHIFT, code:11, Move window to sub-workspace 2, exec, hypr-workspace-group move 2
bindd = SUPER SHIFT, code:12, Move window to sub-workspace 3, exec, hypr-workspace-group move 3
bindd = SUPER SHIFT, code:13, Move window to sub-workspace 4, exec, hypr-workspace-group move 4
bindd = SUPER SHIFT, code:14, Move window to sub-workspace 5, exec, hypr-workspace-group move 5
bindd = SUPER SHIFT, code:15, Move window to sub-workspace 6, exec, hypr-workspace-group move 6
bindd = SUPER SHIFT, code:16, Move window to sub-workspace 7, exec, hypr-workspace-group move 7
bindd = SUPER SHIFT, code:17, Move window to sub-workspace 8, exec, hypr-workspace-group move 8
bindd = SUPER SHIFT, code:18, Move window to sub-workspace 9, exec, hypr-workspace-group move 9
bindd = SUPER SHIFT, code:19, Move window to sub-workspace 10, exec, hypr-workspace-group move 10

# Move window silently within current group
bindd = SUPER SHIFT ALT, code:10, Move window silently to sub-workspace 1, exec, hypr-workspace-group movesilent 1
bindd = SUPER SHIFT ALT, code:11, Move window silently to sub-workspace 2, exec, hypr-workspace-group movesilent 2
bindd = SUPER SHIFT ALT, code:12, Move window silently to sub-workspace 3, exec, hypr-workspace-group movesilent 3
bindd = SUPER SHIFT ALT, code:13, Move window silently to sub-workspace 4, exec, hypr-workspace-group movesilent 4
bindd = SUPER SHIFT ALT, code:14, Move window silently to sub-workspace 5, exec, hypr-workspace-group movesilent 5
bindd = SUPER SHIFT ALT, code:15, Move window silently to sub-workspace 6, exec, hypr-workspace-group movesilent 6
bindd = SUPER SHIFT ALT, code:16, Move window silently to sub-workspace 7, exec, hypr-workspace-group movesilent 7
bindd = SUPER SHIFT ALT, code:17, Move window silently to sub-workspace 8, exec, hypr-workspace-group movesilent 8
bindd = SUPER SHIFT ALT, code:18, Move window silently to sub-workspace 9, exec, hypr-workspace-group movesilent 9
bindd = SUPER SHIFT ALT, code:19, Move window silently to sub-workspace 10, exec, hypr-workspace-group movesilent 10

# Group tab switching (relocated from ALT to CTRL)
bindd = SUPER CTRL, code:10, Switch to group window 1, changegroupactive, 1
bindd = SUPER CTRL, code:11, Switch to group window 2, changegroupactive, 2
bindd = SUPER CTRL, code:12, Switch to group window 3, changegroupactive, 3
bindd = SUPER CTRL, code:13, Switch to group window 4, changegroupactive, 4
bindd = SUPER CTRL, code:14, Switch to group window 5, changegroupactive, 5
bindd = SUPER CTRL, code:15, Switch to group window 6, changegroupactive, 6
bindd = SUPER CTRL, code:16, Switch to group window 7, changegroupactive, 7
bindd = SUPER CTRL, code:17, Switch to group window 8, changegroupactive, 8
bindd = SUPER CTRL, code:18, Switch to group window 9, changegroupactive, 9
bindd = SUPER CTRL, TAB, Next window in group, changegroupactive, f
bindd = SUPER CTRL SHIFT, TAB, Previous window in group, changegroupactive, b
bindd = SUPER CTRL, mouse_down, Next window in group, changegroupactive, f
bindd = SUPER CTRL, mouse_up, Previous window in group, changegroupactive, b
WSGROUPS
    info "workspace-groups: added keybindings"
fi

# 9. Waybar — simplify format-icons for dynamic workspace groups
WAYBAR_CONFIG="$HOME/.config/waybar/config.jsonc"
if [ -f "$WAYBAR_CONFIG" ]; then
    hs_module='."hyprland/workspaces"'
    current_icons=$(jq -r "${hs_module}.\"format-icons\" | keys | length" "$WAYBAR_CONFIG" 2>/dev/null)
    if [ "$current_icons" -gt 2 ] 2>/dev/null; then
        tmp=$(mktemp)
        jq "${hs_module}.\"format-icons\" = {\"active\": \"󱓻\"}" \
            "$WAYBAR_CONFIG" > "$tmp" && mv "$tmp" "$WAYBAR_CONFIG"
        info "waybar: simplified format-icons for dynamic groups"
    else
        info "waybar: format-icons already simplified"
    fi
else
    info "waybar: config not found, skipping"
fi

echo
echo "Done. Restart Hyprland or reboot to activate."
